<!-- f6201c7c-8e42-4f15-8650-a7a04144c497 55b790bd-e694-46fc-80aa-6e6c45417151 -->
# MVP Plan: unblock dynamic tracking, redemption, and basic settlement

## Scope

- Fix indexer event signature and dynamic tracking so all new markets stream trades.
- Correct portfolio math and wire Redemption/Resolver UIs using existing hooks.
- Add a minimal cron-based settlement worker using the OpenSea API key.

## Key Fixes and Features

### 1) Indexer: event signature + dynamic contract registration (CRITICAL)

- Update `packages/indexer/config.yaml` Trade event to match contract (includes `bool isBuy`), and add `SharesRedeemed` and `LiquidityProvided` for complete coverage.
```startLine:endLine:/Users/marcdhi/Marcdhi_Dev/mcg/packages/blockend/contracts/Market.sol
37:56
```

- Config change:
```yaml
# packages/indexer/config.yaml
- name: Market
  abi_file_path: ./abi/Market.json
  handler: ./src/EventHandlers.ts
  events:
    - event: Trade(address indexed user, bool indexed outcome, uint256 ethAmount, uint256 shareAmount, bool isBuy)
      field_selection:
        transaction_fields:
          - hash
          - value
    - event: MarketResolved(bool winningOutcome, uint256 finalReportedPrice)
    - event: SharesRedeemed(address indexed user, uint256 sharesRedeemed, uint256 ethReceived)
    - event: LiquidityProvided(address indexed provider, uint256 initialYesShares, uint256 initialNoShares, uint256 ethAmount)
```

- Implement dynamic Market registration in `MarketFactory.MarketCreated` handler.
        - Example (see HyperIndex docs: contract import): register the new `marketAddress` so subsequent `Trade` events are indexed.
        - Avoid side effects during preload (`!context.isPreload`).

### 2) Indexer: correct position accounting + redemption handling

- Use `event.params.isBuy` (not tx value) to:
        - Update `yesSharesTotal/noSharesTotal` correctly
        - For `Position`: add to `yesShares/noShares` with signed deltas
        - For `totalInvested`: add on buys, subtract on sells
        - Track `realizedPnL` on sells as `(ethAmount - costBasisPortion)` (MVP: subtract ethAmount from invested; realizedPnL remains 0, simple approach)
- Add `SharesRedeemed` handler to:
        - Decrease winning-side user shares by `sharesRedeemed`
        - Increase `realizedPnL` by `ethReceived`
        - Optional: set a `claimedAt` if needed later
- Add `LiquidityProvided` handler to:
        - Initialize creator `Position` yes/no shares with minted amounts and `totalInvested += ethAmount`

### 3) Frontend: fix YES/NO token ID mapping (bug)

- In `packages/frontend/src/hooks/useMarket.ts`, map `YES=1`, `NO=0` for `balanceOf`.

### 4) Frontend: Redemption UI

- New `packages/frontend/src/components/market/RedemptionWidget.tsx` using `useRedeemShares` and a `canRedeem`/`getRedeemableAmount` read.
- Integrate into `pages/Portfolio.tsx` (for resolved markets) and Market detail page.

### 5) Frontend: Temporary Resolver UI

- Light admin-only section/button on Market detail for resolver addresses using `useResolveMarket`.
- “Fetch floor price” button consuming `getFloorPrice()` from `lib/opensea.ts` and prefill final price.

### 6) Settlement worker (cron-based, simple)

- New package `packages/settlement-worker/`:
        - `src/index.ts`: cron job (e.g., every 15–60 mins) reads markets (GraphQL), filters past `resolutionTimestamp` and `status=Open`.
        - `src/opensea.ts`: `getFloorPrice(slug)` wrapper (reuse logic from frontend).
        - `src/resolver.ts`: resolve with a signer using `Market.resolveMarket(finalPrice)`.
        - `.env`: RPC URL, resolver PK, indexer URL, OpenSea key.

## Commands and Environment

- Use Node.js v20, pnpm, docker.
- After editing `schema.graphql`/`config.yaml`: run `pnpm codegen` (indexer).
- After TS edits: run `pnpm tsc --noEmit`.
- Run indexer to validate: `TUI_OFF=true pnpm dev`.

## Essential Edits

- `packages/indexer/config.yaml`: Trade signature, add `SharesRedeemed`, `LiquidityProvided`.
- `packages/indexer/src/EventHandlers.ts`: dynamic registration; use `isBuy`; add two new handlers; fix position accounting.
- `packages/frontend/src/hooks/useMarket.ts`: swap token IDs in `useUserShares`.
- `packages/frontend/src/components/market/RedemptionWidget.tsx`: new.
- `packages/frontend/src/pages/Portfolio.tsx`: integrate redemption; show claimable.
- `packages/settlement-worker/`: new package with cron, OpenSea fetch, resolve calls.

## Notes

- With `preload_handlers: true`, guard external calls with effects or `!context.isPreload`.
- Keep USDC out for MVP. Add analytics in a later pass.

### To-dos

- [ ] Update config.yaml Trade signature; add SharesRedeemed & LiquidityProvided
- [ ] Register new Market contracts on MarketCreated to index Trades
- [ ] Use isBuy for signed deltas; adjust invested and shares
- [ ] Add SharesRedeemed handler to update user shares and realizedPnL
- [ ] Add LiquidityProvided handler to seed creator position and invested
- [ ] Swap YES/NO token IDs in useUserShares hook
- [ ] Create RedemptionWidget and integrate in Portfolio & Market detail
- [ ] Add resolver-only UI to fetch floor price and resolve
- [ ] Scaffold cron-based settlement worker with OpenSea price and resolve
- [ ] Run pnpm codegen, pnpm tsc --noEmit, TUI_OFF=true pnpm dev